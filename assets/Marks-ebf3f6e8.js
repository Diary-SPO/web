import{c as e,R as a,e as t,f as r,o,H as s,M as i,g as n,h as l,G as c,i as m,D as d,j as h,T as u,S as p,k as g,A as f,N as k,l as y,C as b,m as v,b as j,P as _}from"./index-12fcb1ba.js";import{P as S}from"./Panel-b4539d2d.js";import{P as w,g as x}from"./getPerformance-67103f0f.js";import{y as M,W as N,X as I,h as O,p as C,Y as z,Z as T,V as D,$ as G}from"./@vkontakte/icons-ec9bb119.js";import{h as A}from"./makeRequest-ee026c1c.js";import{P as F}from"./PanelHeaderWithBack-57ddcc92.js";import{B as P}from"./Button-a58ba127.js";import{A as B}from"./Avatar-de2956ae.js";import{w as J}from"./winx48-9f855ac5.js";import{H as W}from"./HorizontalScroll-55be4d6e.js";import{u as H}from"./useSnackbar-10f2a8ee.js";import"./Snackbar-9cb98137.js";const R={tint:"_Gradient--mode-tint_5mj23_1",black:"_Gradient--mode-black_5mj23_17",white:"_Gradient--mode-white_5mj23_9"},V={top:"_Gradient--to-top_5mj23_1",bottom:"_Gradient--to-bottom_5mj23_5"},$=({mode:t="tint",to:r="top",...o})=>M(a,{role:"presentation",...o,baseClassName:e(R[t],V[r])}),q=({markCounts:e,totalNumberOfMarks:a,averageMark:t})=>o(c,{header:o(s,{mode:"tertiary",children:"Статистика"}),children:[o(i,{before:o(N,{style:{marginTop:4}}),after:o(n,{size:"s",mark:a}),children:"Суммарное количество оценок:"}),o(i,{before:o(I,{style:{marginTop:4},width:20,height:20}),after:o(n,{size:"s",mark:t&&t.toFixed(3)}),children:"Общий средний балл:"}),e&&o("div",{style:{display:"flex",flexDirection:"row-reverse",justifyContent:"space-around",gap:5},children:Object.keys(e).map((a=>e[a]>0&&o(i,{before:o(n,{mark:l[a],size:"s"}),children:["x ",e[a]]},a)))})]}),U={margin:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",textAlign:"center",padding:32},E=()=>{const[e,a]=O(!1),[t,r]=O(),[i,n]=O({name:"",org:"",city:"",group:""}),l=async e=>{a(!0);const t=localStorage.getItem("data"),o=localStorage.getItem("ava");if(t&&!e){const e=JSON.parse(t);if(e.name&&e.group)return n(e),o&&r(o),void a(!1)}const s=localStorage.getItem("data"),i=JSON.parse(s),l=await(async()=>{try{const e=await g.send("VKWebAppGetUserInfo");return e.id?(localStorage.setItem("ava",e.photo_100),e.photo_100):null}catch(e){return null}})();l&&r(l),n({name:i.name||"",org:i.org||"",city:i.city||"",group:i.group||""}),localStorage.setItem("userData",JSON.stringify(s)),a(!1)};if(C((()=>{l()}),[]),e)return o(d,{children:o(m,{})});const f=o(s,{aside:t&&o(P,{size:"s",after:o(z,{}),"aria-label":"Обновить",mode:"tertiary",onClick:()=>l(!0)}),mode:"tertiary",children:"Личная информация"});return o(c,{mode:"plain",header:f,children:[o($,{mode:"tint",style:U,children:[o(B,{size:96,src:t??J}),o(h,{style:{marginBottom:8,marginTop:20},level:"2",weight:"2",children:i.name}),o(u,{style:{marginBottom:24,color:"var(--vkui--color_text_secondary)"},children:["Студент (",i.group,")"]})]}),o(c,{mode:"plain",header:o(s,{mode:"tertiary",children:"Учебное заведение"}),children:o(p,{before:o(T,{}),subtitle:i.city,children:i.org})})]})},K=({marks:e})=>o("div",{style:{display:"flex"},children:e.map((({date:e,marks:a,absenceType:t})=>o("div",{style:{display:"flex"},children:a.length>0&&!t?a.map(((e,a)=>o(n,{mark:l[e],size:"s"},a))):t?o(n,{size:"s",mark:f[t]}):null},`${e}_${t}`)))}),L=({marksForSubject:e})=>{if(!e)return k;const a=(e=>{const a={};return e.daysWithMarksForSubject.forEach((e=>{const{subjectName:t,daysWithMarks:r}=e;a[t]||(a[t]=[]),a[t].push(...r?.map((e=>({date:new Date(e.day).toLocaleDateString(),marks:e.markValues,absenceType:e.absenceType})))??[])})),a})(e);return o(c,{mode:"plain",header:o(s,{mode:"secondary",children:"Оценки по дисциплинам"}),children:Object.keys(a).map(((e,t)=>o(y,{size:"l",children:o(b,{mode:"shadow",children:[o(d,{children:o(h,{level:"3",children:e})}),o(W,{children:o(K,{marks:a[e]})}),o(v,{marks:a[e].flatMap((({marks:e})=>e))})]})},t)))})},X=({id:e})=>{const[a,s]=O(!1),[i,n]=H(),[l,m]=O(null),[d,h]=O(null),[u,p]=O(null),[g,f]=O(null),k=async e=>{if(!e)return;const a=JSON.parse(await(async e=>(await t(),r(e)))(e));a&&(h(a.totalNumberOfMarks),p(a.averageMark),f(a.markCounts))},y=async e=>{s(!0);try{const a=localStorage.getItem("lastFetchTime");if(!a||Date.now()-Number(a)>=3e4||e){const e=await x();return A(e,(()=>{s(!1),k(e)}),(()=>{n({icon:o(D,{fill:"var(--vkui--color_icon_negative)"}),title:"Ошибка при попытке сделать запрос",subtitle:"Сообщите нам об этом"}),s(!1)}),s,n),localStorage.setItem("savedMarks",JSON.stringify(e)),localStorage.setItem("lastFetchTime",String(Date.now())),m(e),k(e),s(!1),e}s(!1),n({title:"Оценки взяты из кеша",onActionClick:()=>y(!0),action:"Загрузить новые",icon:o(G,{fill:"var(--vkui--color_background_accent)"})});const t=localStorage.getItem("savedMarks"),r=t?JSON.parse(t):null;return k(r),r??void 0}catch(e){return s(!1),void n({icon:o(D,{fill:"var(--vkui--color_icon_negative)"}),title:"Ошибка при попытке загрузить оценки",action:"Попробовать снова",onActionClick:()=>y(!0)})}};return C((()=>{(async()=>{try{const e=await y();m(e)}catch(e){}})()}),[]),o(S,{nav:e,children:[o(F,{title:"Успеваемость"}),o(w,{onRefresh:()=>y(!0),isFetching:a,children:[o(j,{id:"UserInfo",children:o(E,{})}),a?o(c,{children:o(_,{})}):o(q,{totalNumberOfMarks:d,averageMark:u,markCounts:g}),a?o(c,{children:o(_,{})}):o(j,{id:"MarksByGroup",children:o(L,{marksForSubject:l})})]}),i]})};export{X as default};
