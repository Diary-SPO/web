var e=Object.defineProperty,r=Object.defineProperties,t=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,i=(r,t,a)=>t in r?e(r,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):r[t]=a;import{c as s,R as l,f as c,u as d,M as m,A as u,H as f,g as h,C as p,h as g,i as k,G as y,j as b,k as v,T as j,S,d as _,P as O}from"./index--wYC2PF4.js";import{P as M}from"./Panel-fPJSZPud.js";import{P as w,g as x}from"./getPerformance--JDaY_-H.js";import{y as N,D as P,X as D,Y as F,h as C,p as I,Z as T,W,$ as z}from"./@vkontakte/icons-HJ4wZ9QE.js";import{h as G}from"./handleResponse-kGkHOE9v.js";import{H as A}from"./HorizontalScroll-C1YcMeig.js";import{D as B}from"./Div-8NhnMoi4.js";import{P as J}from"./PanelHeaderWithBack-EZo8V8Fv.js";import{A as H}from"./Avatar-WLuuzyxq.js";import{w as R}from"./winx48-J7pHJFzG.js";import{u as $}from"./useSnackbar-1tYziyFU.js";import"./makeRequest-NP7h63fm.js";import"./Snackbar-HLSVggkW.js";import"./Button-YcANNQ5j.js";const q="_Gradient_ott79_1",V="_Gradient--to-bottom_ott79_5",E={tint:"_Gradient--mode-tint_ott79_9",black:"_Gradient--mode-black_ott79_25",white:"_Gradient--mode-white_ott79_17"},L=e=>{var c,d,m=e,{mode:u="tint",to:f="top"}=m,h=((e,r)=>{var t={};for(var i in e)o.call(e,i)&&r.indexOf(i)<0&&(t[i]=e[i]);if(null!=e&&a)for(var i of a(e))r.indexOf(i)<0&&n.call(e,i)&&(t[i]=e[i]);return t})(m,["mode","to"]);return N(l,(c=((e,r)=>{for(var t in r||(r={}))o.call(r,t)&&i(e,t,r[t]);if(a)for(var t of a(r))n.call(r,t)&&i(e,t,r[t]);return e})({role:"presentation"},h),d={baseClassName:s(q,"default"!==u&&E[u],"bottom"===f&&V)},r(c,t(d))))},U=({marks:e})=>d("div",{style:{display:"flex"},children:e.map((({date:e,marks:r,absenceType:t})=>d("div",{style:{display:"flex"},children:r.length>0&&!t?r.map(((e,r)=>d(m,{mark:c[e],size:"s"},r))):t?d(m,{size:"s",mark:u[t]}):null},`${e}_${t}`)))}),X=({marksForSubject:e})=>{if(!(null==e?void 0:e.daysWithMarksForSubject.length))return;const r=(e=>{const r={};for(const t of e.daysWithMarksForSubject){const{subjectName:e,daysWithMarks:a}=t;if(r[e]||(r[e]=[]),a)for(const t of a){const a={date:new Date(t.day).toLocaleDateString(),marks:t.markValues,absenceType:t.absenceType};r[e].push(a)}}return r})(e);return d(y,{mode:"plain",header:d(f,{mode:"secondary",children:"Оценки по дисциплинам"}),children:Object.keys(r).map(((e,t)=>d(h,{size:"l",children:d(p,{mode:"shadow",children:[d(B,{children:d(g,{level:"3",children:e})}),d(A,{children:d(U,{marks:r[e]})}),d(k,{marks:r[e].flatMap((({marks:e})=>e))})]})},t)))})},Y=({markCounts:e,totalNumberOfMarks:r,averageMark:t})=>d(y,{header:d(f,{mode:"tertiary",children:["Статистика ",!e&&"отсутствует"," "]}),children:e?d(P.Fragment,{children:[d(b,{before:d(D,{style:{marginTop:4}}),after:d(m,{size:"s",mark:r}),children:"Суммарное количество оценок:"}),d(b,{before:d(F,{style:{marginTop:4},width:20,height:20}),after:d(m,{size:"s",mark:t}),children:"Общий средний балл:"}),e&&d("div",{style:{display:"flex",flexDirection:"row-reverse",justifyContent:"space-around",gap:5},children:[2,3,4,5].map((r=>e[r]>0&&d(b,{before:d(m,{mark:r,size:"s"}),children:["x ",e[r]]},r)))})]}):void 0}),Z={margin:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",textAlign:"center",padding:32},K=()=>{const[e,r]=C(!1),[t,a]=C({name:"",org:"",city:"",group:""});if(I((()=>{(async()=>{r(!0);const e=localStorage.getItem("data");if(e){const t=JSON.parse(e);if(t.name&&t.group)return a(t),void r(!1)}const t=localStorage.getItem("data"),o=JSON.parse(t);a({name:o.name||"",org:o.org||"",city:o.city||"",group:o.group||""}),localStorage.setItem("userData",JSON.stringify(t)),r(!1)})()}),[]),e)return d(B,{children:d(v,{})});const o=d(f,{mode:"tertiary",children:"Личная информация"});return d(y,{mode:"plain",header:o,children:[d(L,{mode:"tint",style:Z,children:[d(H,{size:96,src:R}),d(g,{style:{marginBottom:8,marginTop:20},level:"2",weight:"2",children:t.name}),d(j,{style:{marginBottom:24,color:"var(--vkui--color_text_secondary)"},children:["Студент (",t.group,")"]})]}),d(y,{mode:"plain",header:d(f,{mode:"tertiary",children:"Учебное заведение"}),children:d(S,{before:d(T,{}),subtitle:t.city,children:t.org})})]})},Q=({id:e})=>{const[r,t]=C(!1),[a,o]=$(),[n,i]=C(null),[s,l]=C(null),[m,u]=C(null),[f,h]=C(null),p=e=>{if(!e)return;const r=(e=>{if(!e.daysWithMarksForSubject.length)return null;const r=e.daysWithMarksForSubject.reduce(((e,r)=>{if(r.daysWithMarks)for(const t of r.daysWithMarks)e.push(...t.markValues);return e}),[]),t=r.length,a=r.reduce(((e,r)=>e+Number(c[r])),0)/t,o={2:0,3:0,4:0,5:0};for(const e of r){const r=Number(c[e]);r>=2&&r<=5&&(o[r]+=1)}return{totalNumberOfMarks:t,averageMark:Number(a.toFixed(3)),markCounts:o}})(e);r&&(l(r.totalNumberOfMarks),u(r.averageMark),h(r.markCounts))},g=async e=>{t(!0);try{const r=localStorage.getItem("lastFetchTime");if(!r||Date.now()-Number(r)>=3e4||e){const e=await x();return G(e,(()=>{t(!1),p(e)}),(()=>{o({icon:d(W,{fill:"var(--vkui--color_icon_negative)"}),title:"Ошибка при попытке сделать запрос",subtitle:"Сообщите нам об этом"}),t(!1)}),t,o),localStorage.setItem("savedMarks",JSON.stringify(e)),localStorage.setItem("lastFetchTime",String(Date.now())),i(e),p(e),t(!1),e}t(!1),o({title:"Оценки взяты из кеша",onActionClick:()=>g(!0),action:"Загрузить новые",icon:d(z,{fill:"var(--vkui--color_background_accent)"})});const a=localStorage.getItem("savedMarks"),n=a?JSON.parse(a):null;return p(n),null!=n?n:void 0}catch(e){return t(!1),void o({icon:d(W,{fill:"var(--vkui--color_icon_negative)"}),title:"Ошибка при попытке загрузить оценки",action:"Попробовать снова",onActionClick:()=>g(!0)})}};return I((()=>{(async()=>{try{const e=await g();i(e)}catch(e){}})()}),[]),d(M,{nav:e,children:[d(J,{title:"Успеваемость"}),d(w,{onRefresh:()=>g(!0),isFetching:r,children:[d(_,{id:"UserInfo",children:d(K,{})}),r?d(y,{children:d(O,{})}):d(Y,{totalNumberOfMarks:s,averageMark:m,markCounts:f}),r?d(y,{children:d(O,{})}):d(_,{id:"MarksByGroup",children:d(X,{marksForSubject:n})})]}),a]})};export{Q as default};
