var e=Object.defineProperty,r=Object.defineProperties,a=Object.getOwnPropertyDescriptors,t=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,i=(r,a,t)=>a in r?e(r,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[a]=t;import{c as s,R as l,f as c,u as d,H as m,M as u,g as h,G as f,h as p,i as g,T as k,S as y,j as b,A as v,k as j,C as S,l as _,d as O,P as w}from"./index-V8iVre27.js";import{P as M}from"./Panel-QWgBTGN8.js";import{P as x,g as N}from"./getPerformance-g1cYj3FL.js";import{y as I,W as P,X as C,h as z,p as D,Y as F,Z as T,c as W,V as G,$ as A}from"./@vkontakte/icons-Hmxnb1rK.js";import{h as B}from"./makeRequest-hnqlHHd1.js";import{P as J}from"./PanelHeaderWithBack-MH-2GNqv.js";import{B as E}from"./Button-bI8mAd_C.js";import{A as H}from"./Avatar-X0XfkpYb.js";import{D as V}from"./Div-aB5xY7rY.js";import{w as R}from"./winx48-J7pHJFzG.js";import{H as $}from"./HorizontalScroll-QF3GDDJv.js";import{u as q}from"./useSnackbar-VhiceFc0.js";import"./Snackbar-a9j_Cux_.js";const U={tint:"_Gradient--mode-tint_5mj23_1",black:"_Gradient--mode-black_5mj23_17",white:"_Gradient--mode-white_5mj23_9"},K={top:"_Gradient--to-top_5mj23_1",bottom:"_Gradient--to-bottom_5mj23_5"},L=e=>{var c,d,m=e,{mode:u="tint",to:h="top"}=m,f=((e,r)=>{var a={};for(var i in e)o.call(e,i)&&r.indexOf(i)<0&&(a[i]=e[i]);if(null!=e&&t)for(var i of t(e))r.indexOf(i)<0&&n.call(e,i)&&(a[i]=e[i]);return a})(m,["mode","to"]);return I(l,(c=((e,r)=>{for(var a in r||(r={}))o.call(r,a)&&i(e,a,r[a]);if(t)for(var a of t(r))n.call(r,a)&&i(e,a,r[a]);return e})({role:"presentation"},f),d={baseClassName:s(U[u],K[h])},r(c,a(d))))},X=({markCounts:e,totalNumberOfMarks:r,averageMark:a})=>d(f,{header:d(m,{mode:"tertiary",children:"Статистика"}),children:[d(u,{before:d(P,{style:{marginTop:4}}),after:d(h,{size:"s",mark:r}),children:"Суммарное количество оценок:"}),d(u,{before:d(C,{style:{marginTop:4},width:20,height:20}),after:d(h,{size:"s",mark:a}),children:"Общий средний балл:"}),e&&d("div",{style:{display:"flex",flexDirection:"row-reverse",justifyContent:"space-around",gap:5},children:[2,3,4,5].map((r=>e[r]>0&&d(u,{before:d(h,{mark:r,size:"s"}),children:["x ",e[r]]},r)))})]}),Y={margin:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",textAlign:"center",padding:32},Z=()=>{const[e,r]=z(!1),[a,t]=z(),[o,n]=z({name:"",org:"",city:"",group:""}),i=async e=>{r(!0);const a=localStorage.getItem("data"),o=localStorage.getItem("ava");if(a&&!e){const e=JSON.parse(a);if(e.name&&e.group)return n(e),o&&t(o),void r(!1)}const i=localStorage.getItem("data"),s=JSON.parse(i),l=await(async()=>{try{const e=await b.send("VKWebAppGetUserInfo");return e.id?(localStorage.setItem("ava",e.photo_100),e.photo_100):null}catch(e){return null}})();l&&t(l),n({name:s.name||"",org:s.org||"",city:s.city||"",group:s.group||""}),localStorage.setItem("userData",JSON.stringify(i)),r(!1)};if(D((()=>{i()}),[]),e)return d(V,{children:d(p,{})});const s=d(m,{aside:a&&d(E,{size:"s",after:d(F,{}),"aria-label":"Обновить",mode:"tertiary",onClick:()=>i(!0)}),mode:"tertiary",children:"Личная информация"});return d(f,{mode:"plain",header:s,children:[d(L,{mode:"tint",style:Y,children:[d(H,{size:96,src:null!=a?a:R}),d(g,{style:{marginBottom:8,marginTop:20},level:"2",weight:"2",children:o.name}),d(k,{style:{marginBottom:24,color:"var(--vkui--color_text_secondary)"},children:["Студент (",o.group,")"]})]}),d(f,{mode:"plain",header:d(m,{mode:"tertiary",children:"Учебное заведение"}),children:d(y,{before:d(T,{}),subtitle:o.city,children:o.org})})]})},Q=({marks:e})=>d("div",{style:{display:"flex"},children:e.map((({date:e,marks:r,absenceType:a})=>d("div",{style:{display:"flex"},children:r.length>0&&!a?r.map(((e,r)=>d(h,{mark:c[e],size:"s"},r))):a?d(h,{size:"s",mark:v[a]}):null},`${e}_${a}`)))}),ee=()=>W((()=>d(f,{mode:"plain",header:d(m,{mode:"secondary",children:"Оценки по дисциплинам"}),children:d(j,{size:"l",children:d(S,{mode:"shadow",children:d(V,{children:d(g,{level:"3",children:"Нет данных"})})})})})),[]),re=({marksForSubject:e})=>{if(!e)return d(ee,{});const r=(e=>{const r={};return e.daysWithMarksForSubject.forEach((e=>{const{subjectName:a,daysWithMarks:t}=e;if(r[a]||(r[a]=[]),t){const e=t.map((e=>({date:new Date(e.day).toLocaleDateString(),marks:e.markValues,absenceType:e.absenceType})));r[a].push(...e)}})),r})(e);return d(f,{mode:"plain",header:d(m,{mode:"secondary",children:"Оценки по дисциплинам"}),children:Object.keys(r).map(((e,a)=>d(j,{size:"l",children:d(S,{mode:"shadow",children:[d(V,{children:d(g,{level:"3",children:e})}),d($,{children:d(Q,{marks:r[e]})}),d(_,{marks:r[e].flatMap((({marks:e})=>e))})]})},a)))})},ae=({id:e})=>{const[r,a]=z(!1),[t,o]=q(),[n,i]=z(null),[s,l]=z(null),[m,u]=z(null),[h,p]=z(null),g=e=>{if(!e)return;const r=(e=>{if(!e.daysWithMarksForSubject.length)return null;const r=e.daysWithMarksForSubject.reduce(((e,r)=>(r.daysWithMarks&&r.daysWithMarks.forEach((r=>e.push(...r.markValues))),e)),[]),a=r.length,t=r.reduce(((e,r)=>e+Number(c[r])),0)/a,o={2:0,3:0,4:0,5:0};return r.forEach((e=>{const r=c[e];r>=2&&r<=5&&(o[r]+=1)})),{totalNumberOfMarks:a,averageMark:Number(t.toFixed(3)),markCounts:o}})(e);r&&(l(r.totalNumberOfMarks),u(r.averageMark),p(r.markCounts))},k=async e=>{a(!0);try{const r=localStorage.getItem("lastFetchTime");if(!r||Date.now()-Number(r)>=3e4||e){const e=await N();return B(e,(()=>{a(!1),g(e)}),(()=>{o({icon:d(G,{fill:"var(--vkui--color_icon_negative)"}),title:"Ошибка при попытке сделать запрос",subtitle:"Сообщите нам об этом"}),a(!1)}),a,o),localStorage.setItem("savedMarks",JSON.stringify(e)),localStorage.setItem("lastFetchTime",String(Date.now())),i(e),g(e),a(!1),e}a(!1),o({title:"Оценки взяты из кеша",onActionClick:()=>k(!0),action:"Загрузить новые",icon:d(A,{fill:"var(--vkui--color_background_accent)"})});const t=localStorage.getItem("savedMarks"),n=t?JSON.parse(t):null;return g(n),null!=n?n:void 0}catch(e){return a(!1),void o({icon:d(G,{fill:"var(--vkui--color_icon_negative)"}),title:"Ошибка при попытке загрузить оценки",action:"Попробовать снова",onActionClick:()=>k(!0)})}};return D((()=>{(async()=>{try{const e=await k();i(e)}catch(e){}})()}),[]),d(M,{nav:e,children:[d(J,{title:"Успеваемость"}),d(x,{onRefresh:()=>k(!0),isFetching:r,children:[d(O,{id:"UserInfo",children:d(Z,{})}),r?d(f,{children:d(w,{})}):d(X,{totalNumberOfMarks:s,averageMark:m,markCounts:h}),r?d(f,{children:d(w,{})}):d(O,{id:"MarksByGroup",children:d(re,{marksForSubject:n})})]}),t]})};export{ae as default};
