var e=Object.defineProperty,r=Object.defineProperties,a=Object.getOwnPropertyDescriptors,t=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,i=(r,a,t)=>a in r?e(r,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[a]=t;import{c as s,R as l,e as c,o as m,H as d,M as u,f as h,G as p,g as f,D as g,h as k,T as y,S as b,i as v,A as j,N as S,j as _,C as O,k as w,b as M,P as x}from"./index-716dd2fc.js";import{P as N}from"./Panel-eb4ddde2.js";import{P as I,g as P}from"./getPerformance-26cf533a.js";import{y as C,S as z,V as D,h as T,p as F,W as G,X as W,Q as A,Y as B}from"./@vkontakte/icons-d137ec12.js";import{h as J}from"./makeRequest-d3f44c26.js";import{P as E}from"./PanelHeaderWithBack-cc3484e7.js";import{B as H}from"./Button-9144f7df.js";import{A as V}from"./Avatar-fa3f7afc.js";import{w as R}from"./winx48-9f855ac5.js";import{H as q}from"./HorizontalScroll-dc2cd0e8.js";import{u as U}from"./useSnackbar-8d09d7d9.js";import"./Snackbar-3177c796.js";const $={tint:"_Gradient--mode-tint_5mj23_1",black:"_Gradient--mode-black_5mj23_17",white:"_Gradient--mode-white_5mj23_9"},K={top:"_Gradient--to-top_5mj23_1",bottom:"_Gradient--to-bottom_5mj23_5"},L=e=>{var c,m,d=e,{mode:u="tint",to:h="top"}=d,p=((e,r)=>{var a={};for(var i in e)o.call(e,i)&&r.indexOf(i)<0&&(a[i]=e[i]);if(null!=e&&t)for(var i of t(e))r.indexOf(i)<0&&n.call(e,i)&&(a[i]=e[i]);return a})(d,["mode","to"]);return C(l,(c=((e,r)=>{for(var a in r||(r={}))o.call(r,a)&&i(e,a,r[a]);if(t)for(var a of t(r))n.call(r,a)&&i(e,a,r[a]);return e})({role:"presentation"},p),m={baseClassName:s($[u],K[h])},r(c,a(m))))},Q=({markCounts:e,totalNumberOfMarks:r,averageMark:a})=>m(p,{header:m(d,{mode:"tertiary",children:"Статистика"}),children:[m(u,{before:m(z,{style:{marginTop:4}}),after:m(h,{size:"s",mark:r}),children:"Суммарное количество оценок:"}),m(u,{before:m(D,{style:{marginTop:4},width:20,height:20}),after:m(h,{size:"s",mark:a}),children:"Общий средний балл:"}),e&&m("div",{style:{display:"flex",flexDirection:"row-reverse",justifyContent:"space-around",gap:5},children:[2,3,4,5].map((r=>e[r]>0&&m(u,{before:m(h,{mark:r,size:"s"}),children:["x ",e[r]]},r)))})]}),X={margin:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",textAlign:"center",padding:32},Y=()=>{const[e,r]=T(!1),[a,t]=T(),[o,n]=T({name:"",org:"",city:"",group:""}),i=async e=>{r(!0);const a=localStorage.getItem("data"),o=localStorage.getItem("ava");if(a&&!e){const e=JSON.parse(a);if(e.name&&e.group)return n(e),o&&t(o),void r(!1)}const i=localStorage.getItem("data"),s=JSON.parse(i),l=await(async()=>{try{const e=await v.send("VKWebAppGetUserInfo");return e.id?(localStorage.setItem("ava",e.photo_100),e.photo_100):null}catch(e){return null}})();l&&t(l),n({name:s.name||"",org:s.org||"",city:s.city||"",group:s.group||""}),localStorage.setItem("userData",JSON.stringify(i)),r(!1)};if(F((()=>{i()}),[]),e)return m(g,{children:m(f,{})});const s=m(d,{aside:a&&m(H,{size:"s",after:m(G,{}),"aria-label":"Обновить",mode:"tertiary",onClick:()=>i(!0)}),mode:"tertiary",children:"Личная информация"});return m(p,{mode:"plain",header:s,children:[m(L,{mode:"tint",style:X,children:[m(V,{size:96,src:null!=a?a:R}),m(k,{style:{marginBottom:8,marginTop:20},level:"2",weight:"2",children:o.name}),m(y,{style:{marginBottom:24,color:"var(--vkui--color_text_secondary)"},children:["Студент (",o.group,")"]})]}),m(p,{mode:"plain",header:m(d,{mode:"tertiary",children:"Учебное заведение"}),children:m(b,{before:m(W,{}),subtitle:o.city,children:o.org})})]})},Z=({marks:e})=>m("div",{style:{display:"flex"},children:e.map((({date:e,marks:r,absenceType:a})=>m("div",{style:{display:"flex"},children:r.length>0&&!a?r.map(((e,r)=>m(h,{mark:c[e],size:"s"},r))):a?m(h,{size:"s",mark:j[a]}):null},`${e}_${a}`)))}),ee=({marksForSubject:e})=>{if(!e)return S;const r=(e=>{const r={};return e.daysWithMarksForSubject.forEach((e=>{var a;const{subjectName:t,daysWithMarks:o}=e;r[t]||(r[t]=[]),r[t].push(...null!=(a=null==o?void 0:o.map((e=>({date:new Date(e.day).toLocaleDateString(),marks:e.markValues,absenceType:e.absenceType}))))?a:[])})),r})(e);return m(p,{mode:"plain",header:m(d,{mode:"secondary",children:"Оценки по дисциплинам"}),children:Object.keys(r).map(((e,a)=>m(_,{size:"l",children:m(O,{mode:"shadow",children:[m(g,{children:m(k,{level:"3",children:e})}),m(q,{children:m(Z,{marks:r[e]})}),m(w,{marks:r[e].flatMap((({marks:e})=>e))})]})},a)))})},re=({id:e})=>{const[r,a]=T(!1),[t,o]=U(),[n,i]=T(null),[s,l]=T(null),[d,u]=T(null),[h,f]=T(null),g=e=>{if(!e)return;const r=(e=>{try{const r=e.daysWithMarksForSubject.reduce(((e,r)=>(r.daysWithMarks&&r.daysWithMarks.forEach((r=>e.push(...r.markValues))),e)),[]),a=r.length,t=r.reduce(((e,r)=>e+Number(c[r])),0)/a,o={2:0,3:0,4:0,5:0};return r.forEach((e=>{const r=c[e];r>=2&&r<=5&&(o[r]+=1)})),{totalNumberOfMarks:a,averageMark:Number(t.toFixed(3)),markCounts:o}}catch(e){return null}})(e);r&&(l(r.totalNumberOfMarks),u(r.averageMark),f(r.markCounts))},k=async e=>{a(!0);try{const r=localStorage.getItem("lastFetchTime");if(!r||Date.now()-Number(r)>=3e4||e){const e=await P();return J(e,(()=>{a(!1),g(e)}),(()=>{o({icon:m(A,{fill:"var(--vkui--color_icon_negative)"}),title:"Ошибка при попытке сделать запрос",subtitle:"Сообщите нам об этом"}),a(!1)}),a,o),localStorage.setItem("savedMarks",JSON.stringify(e)),localStorage.setItem("lastFetchTime",String(Date.now())),i(e),g(e),a(!1),e}a(!1),o({title:"Оценки взяты из кеша",onActionClick:()=>k(!0),action:"Загрузить новые",icon:m(B,{fill:"var(--vkui--color_background_accent)"})});const t=localStorage.getItem("savedMarks"),n=t?JSON.parse(t):null;return g(n),null!=n?n:void 0}catch(e){return a(!1),void o({icon:m(A,{fill:"var(--vkui--color_icon_negative)"}),title:"Ошибка при попытке загрузить оценки",action:"Попробовать снова",onActionClick:()=>k(!0)})}};return F((()=>{(async()=>{try{const e=await k();i(e)}catch(e){}})()}),[]),m(N,{nav:e,children:[m(E,{title:"Успеваемость"}),m(I,{onRefresh:()=>k(!0),isFetching:r,children:[m(M,{id:"UserInfo",children:m(Y,{})}),r?m(p,{children:m(x,{})}):m(Q,{totalNumberOfMarks:s,averageMark:d,markCounts:h}),r?m(p,{children:m(x,{})}):m(M,{id:"MarksByGroup",children:m(ee,{marksForSubject:n})})]}),t]})};export{re as default};
